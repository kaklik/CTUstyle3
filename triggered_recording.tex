Because recording and then processing the large amount of data captured continuously over thunderstorm development is technically difficult (the technical difficulties are detailed in the chapter Proposed Instrumentation, specifically in sections describing radio and camera instruments), it is needed to have the ability to determine the precise time of lightning event, with a low rate of false detections. That requirement is enhanced by the fact that data recording is triggered by every false detection, which takes several minutes. This interval creates a “blind” dead time during which the instrumentation is unable to capture another event. To solve that issue, multiple iterations of a mobile measurement system and detectors, which are triggered by electromagnetic emissions produced by lightning, have been developed.
Although optical, radio-wave (electromagnetic), and infrasound-based lightning detection methods exist, the radio-wave detection method is considered to be the most suitable for the intended application, due to its detection range and relative insensitivity to meteorological conditions (hail, snow, rain, and sunlight) at the time of the lightning discharge. It is also considered suitable for the near-to-real-time detection of lightning.
The another requirement of the proposed system is being capable of the precise detects of lightning with a precision in order of several kilometers in position and better than millisecond in the time. The widespread method used for radio lightning detection is based on the detection of the magnetic part of an electromagnetic field generated by lightning. Examples of instruments using this method available for comparison in the Czech Republic include the use of the SLAVIA magnetic loop antenna \cite[Kolmaov2013AnalysisOB] and the stations of the lightning detection system deployed in the Blitzortung.org network \cite[Blitzortung].  However, these systems are not designed to be highly portable, nor to be used as a measurement trigger source in offline and stand-alone operation, making it necessary for us to find a mobile, lightweight and low power consumption lightning detector.
Based on sources in the literature review section /ref suggests the development and implementation of algorithms for real-time lightning detection in ground-based systems pose that topic to an already solved problem, which is only a part of more sophisticated lightning location and mapping systems. Unfortunately lightning detection in these systems is based on signal level detection. The signal level seems to be set to individual stations based on the analysis of datastream coming from the station by the network server.
That simple solution is not suitable to detect lightning in generic electromagnetic noisy environments and requires station placement in electromagnetically quiet areas. There also exists a conference paper 10.1109/ICISE.2010.5689931 introducing an adaptive signal detection algorithm based on short-time energy detection and Constant false alarm rate (CFAR) for real-time VHF intracloud lightning signal detection. This adaptive approach is promising to enhance the performance of lightning detection systems in ground-based setups by dynamically adjusting to varying signal characteristics, but unfortunately the statistics of noise background needs to be known. Therefore that could be hardly used for mobile measurements. Therefore there is not an existing solution which could be obviously used for the planned research.

\sec Off-the-shelf lightning detection
\label[LIGHTNING01A]

Initially I investigated the lightning triggering device based on AMS AS3935 integrated circuit and using a coil antenna. The device meets the requirements of mobility, and low power consumption. For measurements coincidence between ionizing radiation and lightning on aboard aircraft as example, the compact physical size of the device is also a considerable advantage, therefore the solution seems to be promising.
Then I compared the performance and reliability of the detector with the Blitzortung lightning detection network. I choose Blitzortung as a network which has a good deployment in central Europe where the mobile measurements were performed.
Therefore two detection systems were selected for atmospheric discharge detection in this study: the device based on the AMS AS3935 integrated circuit and a coil antenna and the Blitzortung lightning detection network [12]. Both these lightning detection systems use radio emission reception at VLF frequencies. The devices differ in the design and realization of the antennas and implementation of the lightning detection algorithm.
The device equipped by AMS AS3935 uses LIGHTNING01A  MLAB module with a coreless coil antenna connected as a resonant LC circuit (Figure 1).  The resonant frequency of the coil antenna (MA5532-AE) with temperature insensitive C0G ceramic capacitors is matched at 500 kHz ±3.5 \%. The receiver for the signal from the antenna is integrated in the circuit [13] manufactured by AMS company. In fact this strict matching requirement is required by the IC datasheet and is quite constraining and effectively limits the possible application of the circuit.
According to manufacturer description the integrated circuit processes signals based on the signal level threshold detected by a comparator. If the comparator triggers, the proprietary signal processing unit algorithmically analyzes the signal. The output of the signal processing algorithm implemented in the AS3935 circuit consists of a classification of signal relevance: lightning discharge (8), artificial disturbance (4) or high noise level (1). The algorithm also determines the approximate distance and the estimated energy of the lightning discharge based on signal shape.
The internal registers configuration for a measurement described below was set to “outdoor mode” by AFE_GB control register. All other registers are kept with implicit values.
The circuit diagram including the AS3935 is shown in figure 2. The integrated circuit is powered by a 3.6 V from one primary lithium-thionyl chloride cell without usage of an integrated LDO (low drop-out) stabilizer. An I2C (Inter-Integrated Circuit) bus is used for communication with a data logger that also records data from pressure and temperature sensors. A GPS (Global Positioning System) receiver is used for logging of the precise time. The data is stored on a SDcard in a module [14].
A block diagram of the interconnections is shown in figure 3. The used firmware for the device is available at [15].

\medskip
\picw=10cm \cinspic ./img/LIGHTNING01A.png
\caption/f The bottom side of the LIGHTNING01A module [23]. The antenna coil is visible on the left. The tuning capacitors and Q limiting resistor are mounted on the right side from the antenna.
\medskip


\medskip
\picw=15cm \cinspic ./img/LIGHTNING01A_schematics.png
\caption/f Schematic diagram of the lightning sensor based on commercially available AMS AS3935 IC (module LIGHTNING01A [23]).
\medskip

\medskip
\picw=15cm \cinspic ./img/lightning_detector_block_diagram.png
\caption/f Schematic block diagram of the examined lightning detector. Detailed schematics of modules are available at [14], [22-24].
\medskip

The time response of the lightning detector was tested in the laboratory prior to field measurements using a power signal generator with a wire loop of 60 mm diameter. The wire loop was placed at a distance of 30 mm from the antenna. The interrupt output was captured by an oscilloscope. Response time to a rectangular signal was 93 ms (±1 ms). The rectangular signal pulse was classified by the internal algorithm as a disturbance  (“DIVIS4” output in the log file). The response time to the received signal was found not to be constant for each signal. Some pulses were classified as lightning (“DIVIS8” in log file) by the proprietary algorithm where response time was only a few milliseconds. Due to the time delay introduced by the algorithm, the device could be potentially used for triggering of other measuring devices by using a pretrigger recording buffer of maximal algorithm latency plus lightning duration. For a lightning event duration of less than 900 ms, a one second pre-trigger buffer was found to be suitable.

The proposed system, powered by a one LS33600 cell, can operate continuously for five days. Power consumption is dominated by the GPS receiver. Lifetime of the system without GPS is approximately three months. For measurements in the field, the instrument is mounted on the roof of a measurement car inside a waterproof plastic box as shown in figure 4.

\medskip
\picw=15cm \cinspic ./img/DIVISEK01_Deployment.png
\caption/f The examined deployment on the roof of a car. The module LIGHTNING01A \cite[LIGHTNING01A] with antenna is located in the upper right corner of the box. Module with battery is DATALOGGER01A \cite[DATALOGGER01A]. GPS receiver \cite[GPS01B] is located in the upper left corner with connected black GPS antenna. Rest module beside LIGHTNING01A is ALTIMET01A \cite[ALTIMET01A].\label[DIVISEK01_Deployment]
\medskip

\sec Blitzortung network

The second investigated option of triggering was the use of the Blitzortung.org network. Blitzortung.org is a World-Wide Low-Cost Community-Based TDOA Lightning Detection and Lightning Location Network \cite[Blitzortung, Blitzortung.org]. Blitzortung.org collects signals which are received by a combination of  multiple magnetic loop antennas and electric monopoles deployed at network stations \cite[Blitzortung.org]. The configuration, implementation and sensitivity of stations are not uniform. There are multiple causes for these differences. e.g. - the network members have different hardware versions, different quality of maintenance and the antennas are mounted at different locations \urlnote{https://www.blitzortung.org/en/station_list}.

Such variance of network parameters could be considered as beneficial because it increases sensitivity to different lightning signal types. The most common implementation of the magnetic loop antenna in Blitzortung.org network sites consists of several loops of shielded coaxial cable, where the inner conductor is used for the magnetic loop itself and one end of the shield is connected to the antenna amplifier ground. The antenna is not tuned to specific resonant frequency. However, the goal of the station operators is to maintain the highest achievable resonant frequency [https://www.blitzortung.org/Documents/TOA_Blitzortung.pdf].

The Blitzortung controller outputs a 256 byte signal fragment covering the pulse with a time resolution of 1.95 μs along with the timestamp of the trigger and metadata of the station location, GPS signal quality and validity of data. Detailed signal processing is carried out on the network server. The final results of the data processing in the Blitzortung network is the approximate location of the sources of each captured pulse. The signal processing is carried out in two steps. In the first step, a starting point is computed by a time of arrival algorithm \cite[TOALightningLocationRetrievalonSphericalandOblateSpheroidalEarthGeometries] from the first four time stamps corrected for time of group arrival \cite[TOGA].  In the second step, a numerical  method  is  used  to  minimize  the  sum  of squared  distances  to  the hyperbolic curves.

In order to use the Blitzortung as a recording trigger both the processed data from the server and use of the station itself were investigated. The usage of the Blitzortung station hardware was relatively quickly abandoned, because the station is not constructed to trigger on lightning signals in proximity of the thunderstorm. Therefore the station usually reaches something like an “overange” which is called an “interference mode” in Blitzortung.org terminology \urlnote{https://info.lightningmaps.org/doku.php?id=en:hardware:red:operation:interference}. Practical result is that the station is not able to generate relevant triggers to lightning. Instead, it triggers very frequently. Sometimes the opposite situation arises - the Blitzortung station is able to see lightning far away, but is not able to trigger lightning in a near vicinity. The situation is dependent probably on the storm development and the terrain. Whatever, in both cases the station trigger output is not usable for triggering other devices. There is a possibility that the situation could be resolved by changing the Blitzortung station firmware, unfortunately the firmware is closed source, similarly to the exact implementation of location algorithms used on the servers.

\sec Comparison of different triggering methods

During the triggering method development, the devices were regularly tested by a car measurement campaign. There could be shown an example of data captured during a thunderstorm near the village Borkovice, Czechia (car position 49.1949915 N, 14.639835 E, at altitude 427 m a.s.l.) on August 3, 2019 as shown in figure \cite[lightning_times].


\medskip
\label[lightning_times]
\picw=15cm \cinspic ./img/lightning_times.png
\caption/f The position and timing of a thunderstorm at Borkovice. The circles are positions of lightning registered by the Blitzortung network. Colour depends on the relative time of lightning after a measurement car stops. The car position is marked as a blue cross.
\medskip


The timestamp of lightning detected by LIGHTNING01A was recorded with a 1 s accuracy. The Blitzortung network provides timestamps down to a 1 µs accuracy. Fig. \ref[detection_timeseries] shows all lightning triggered signals in all devices over a time period from 12:49 to 13:52 UTC, a time interval during which the car did not change position. LIGHTNING01A distinguished between artificial discharges (depicted in the Fig. \ref[detection_coincidences] as DIVIS4) and natural lightning (depicted in the figure as DIVIS8). Coincidences between LIGHTNING01A and Blitzortung.org detections are shown in Tab. \ref[t1]. Nearest detections around the measurement car are depicted on the map in Fig \ref[lightning_times]. Tab. \ref[t1] and Fig. \ref[detection_coincidences] are generated by algorithms realized by Jupyter notebooks \cite[Coincidences]. Final assessment of binary time events data was done by a similar approach as described in a work \cite[Donges2016].


\medskip
\label[detection_timeseries]
\picw=15cm \cinspic ./img/detection_timeseries.png
\caption/f Detections of the two studied methods. For Blitzortung there are detections labeled as BLITZ, vertical axis corresponds to the distance between the Blitzortung.org location and the fixed position of the LIGHTNING01A deployment. Vertical lines represent all LIGHTNING01A’s detections (DIVIS48). Triangles pointing to detections recognized by LIGHTNING01A as lightning (DIVIS8). For LIGHTNING01A the vertical axis is not relevant, because the sensor does not provide a precise distance.
\medskip

\midinsert \clabel[t1]{Table of coincidence rates among detectors.}
\ctable{ccccrrcrc}{
\hfil  & Count & BLITZ5 & BLITZ10 & BLITZ20 & BLITZ30 & DIVIS48 & DIVIS4 & DIVIS8 \crl \tskip1pt
{\bf BLITZ5}  & 19  & 1.000 & 1.000 & 1.000 & 1.000 & 0.947 & 0.895 & 0.368  \cr
{\bf BLITZ10} & 78  & 0.462 & 1.000 & 1.000 & 1.000 & 0.872 & 0.846 & 0.141  \cr
{\bf BLITZ20} & 109 & 0.358 & 0.844 & 1.000 & 1.000 & 0.798 & 0.734 & 0.147  \cr
{\bf BLITZ30} & 123 & 0.317 & 0.756 & 0.894 & 1.000 & 0.797 & 0.732 & 0.138  \cr
{\bf DIVIS48} & 128 & 0.164 & 0.453 & 0.492 & 0.539 & 1.000 & 0.875 & 0.156  \cr
{\bf DIVIS4}  & 110 & 0.173 & 0.491 & 0.527 & 0.573 & 1.000 & 1.000 & 0.018  \cr
{\bf DIVIS8}  & 18  & 0.111 & 0.222 & 0.278 & 0.333 & 1.000 & 0.111 & 1.000 \cr
}
\caption/t Table of coincidence rates among detectors. The presented values are the proportion of detections in the row-labeled detector for which there is at least one coincident detection of the column-labeled detector. The Blitzortung network is represented by virtual detectors BLITZ5, BLITZ10, BLITZ20 and BLITZ30, which are considered triggered upon a registered lightning in a 5 km, 10 km, 20 km and 30 km radius respectively around the LIGHTNING01A deployment. DIVIS48, DIVIS4 and DIVIS8 is the LIGHTNING01A detector with different filtering of candidate detections, DIVIS48 having the most lenient filtering. Count represents the absolute number of events measured for detector/conditions in each row.
\endinsert

\medskip
\label[detection_coincidences]
\picw=15cm \cinspic ./img/detection_coincidences.png
\caption/f Map of Blitzortung.org detections with LIGHTNING01A coincidences displayed. White marks show positions of all Blitzortung.org detections in the region and time period of interest. If a Blitzortung.org detection coincides with a DIVIS4 or DIVIS8 detection, an additional blue or red mark, respectively, is placed.
\medskip


The records produced by LIGHTNING01A allow to pinpoint the absolute time of detected event within a ±1 s window. As a basic evaluation of LIGHTNING01A’s fitness to trigger other measurement instruments, where coincidences were counted  among LIGHTNING01A detections and detections from Blitzortung.org in multiple predefined radii. The coincidence rates obtained are presented in table \ref[t1]. Events were considered coincident if they fell within a ±1.5 s time window. This value for the window width was selected such that the absolute time uncertainty of LIGHTNING01A records, the latency of LIGHTNING01A response, and the duration of lightning phenomena, which may conceivably be in the order of hundreds of milliseconds, were accounted for. For window widths in the range of ±1.2 s to ±2.0 s, the coincidence rate between any pair of detectors does not differ by more than 0.05 from the table value, which corresponds to the window width of ±1.5 s.

For illustration, those of Blitzortung.org detections which were coincident with LIGHTNING01A detections were picked out, and these are plotted on a map in figure \ref[detection_coincidences]. It should be noted that none of the systems compared here has 100\% detection efficiency \cite[Blitzortung_evaluation].

If Blitzortung.org is postulated as a reference system, it can be seen that LIGHTNING01A (see the column DIVIS48 in the table) covers 94.7\% of Blitzortung detections in the range of 5 km (BLITZ5) and more than 79\% in the range of 30 km (see the line BLITZ30 in the table). The detection of long-distance lightning is possibly influenced by the directional characteristics of the antenna. The sensitivity of the antenna (measured in the number of coincident lightning) is higher in the direction perpendicular to the antenna orientation (see figure \ref[detection_coincidences]; compare the sector around 49.0° N, 14.3° E with 49.3° N, 14.5° E).

It can be seen from table \ref[t1] that the proprietary lightning detection algorithm implemented in the AMS chip, which is supposed to distinguish lightning from man-made disturber, cannot be relied upon. Only 36.8\% of lightning detected by Blitzortung.org are considered as lightning by LIGHTNING01A (DIVIS8). Therefore, all DIVIS8 and DIVIS4 events (DIVIS48) have to be considered. However, 42.7\% of DIVIS4 detections are not registered by Blitzortung at distances up to 30 km. These are likely to be false detections or detections beyond the evaluated range of 30 km.
Blitzortung.org network and LIGHTNING01A detector differ not only in sensitivity, but also in usability due to issues of network connectivity, power requirements, device size, and noise filtering capabilities. For most of these parameters, the LIGHTNING01A device was found only partially suitable as an electromagnetic lightning detector used in this work for terrain measurement. Blitzortung.org is designed to filter noise signals (false detections) by a network of detectors. Consequently, Blitzortung.org gives a useful trigger after the signal has been processed by a network server. It is done in seconds and it is too slow for the mobile measurement purposes. LIGHTNING01A has limited ability to reject autonomously noise signals which is important to avoid filling a memory of other instruments by data captured by false trigger signals, but this ability is not sufficiently robust.

However, the findings looked initially promising, because LIGHTNING01A is a lightweight, highly mobile, battery operated lightning detection system based on the AS3935 integrated circuit  with possible application of radiation measurement in thunderstorms on board of aircraft.

This LIGHTNING01A is a suitable only for triggering terrain measurement devices (lightning discharges mapping device, ionizing radiation detectors, electric field measurement, etc.) with presumption that triggered devices are capable to record the data in interval at a least from one second before the trigger to one second after the trigger, which is caused of uncertainty of lightning trigger output from the AS3935 chip.

Additionally, for applications like ionizing radiation measurements, the sensitivity is considered too high, since lightning more than 10 km away from the ionizing radiation measurement venue is not of interest. The sensitivity of the AS3935 device can be decreased by increasing the level of the lightning detection threshold. This can be done by setting the internal SREJ or WDTH registers of the AS3935, as shown in figure 20 or 21 in the datasheet \cite[AS3935_datasheet], but this also affects the overall sensitivity of the device. Therefore, the false negative rate for near lightning is increased.

Only a slight directional sensitivity of the antenna was observed. This could theoretically be compensated by pointing the AS3935’s antenna (or the whole measurement car) towards the thunderclouds; however, for close lightning within a 5 km radius, this effect is negligible.
In conclusion I found out that a detector based on the currently widely used detection chip AS3935 has limited usability for purposes of lightning recognition and is not able to detect some discharges. Further search is therefore necessary in order to find a more reliable way of lightning detection and triggering during storm development.

\sec Additional investigation of triggering methods

Since the previously mentioned method using existing commercially available solutions for triggering recordings proved to be insufficient during actual measurements, it was necessary to explore further possibilities.
From the signal detection theory, if the signal is known and determined, the signal can be detected by using signal replication and correlation method or the matched filter method. However the lightning signal is time-space random and mostly uncertain (see typical lightning pulse description in Introductory chapter). Therefore there is only option to use the energy detection to detect the lightning signal. That approach is examined in the following paragraphs.

\secc Using the oscilloscope to generate recording trigger
\label[lightning_triggerring_method]

Because, the initial use of a VLF antenna or magnetic loop seemed to be suitable for capturing lightning signals in required quality. The additional search for trigger method was focused on the suitable signal analyzing methods. 

\medskip
\label[mounted_oscilloscope]
\picw=15cm \cinspic ./img/oscilloscope.png
\caption/f Oscilloscope used for lightning triggered recording on board of CAR1. 
\medskip

To address this challenge, a full-featured, fast desktop oscilloscope equipped with deep memory and with sophisticated trigger settings based on signal characteristics was utilized. Initially, a single loop VLF antenna made of UTP cable, originally developed for the Ionozor project, was connected to one of the oscilloscope channels. The antenna design was based on the use of VLFANT01 module, with the 10 m length, STP cable coiled into four loops (STP antenna). The STP antenna loops was placed horizontally directly at the plywood base mounted on the car roof. See  Fig \ref[loop_antenna]. for details.
The oscilloscope was mounted on the back seat of the car by ISOFIX base and directly powered by a stack of Li-pol batteries totalling to 96 V. That solution was selected to completely avoid a possibility of noise generated from on board 230 V switching power supply in the testing car. 
Subsequently, various trigger settings on the oscilloscope during thunderstorms were tested. The most effective setting turned out to be one that activated the recording (oscilloscope trigger output) based on a combination of threshold level and pulse length. This result is logically justified by the fact that a lightning discharge is a high-energy event involving charge transfer over a significant duration.
In a basic explanation, the height of the observed pulse corresponds to the rate of change in the magnetic field, and the duration corresponds to the charge being transferred. That  trigger setup proved itself immune enough that the oscilloscope could be also later powered by 230 V power generated from 12 V car on board power by switching power supply, despite the fact the signal recording itself was heavily affected by interference coming from that power supply.
Another advantage of that oscilloscope-based setup was this trigger setting ultimately allowed for the recording of the full length of the lightning discharge signal up to few seconds.  However, the price for such a possibility was a long storage time corresponding to many minutes of dead time.
The information gathered from these experiments and subsequently obtained from the recorded signals led to questioning of the assumptions stated in the introductory chapter. According to the structure of the signal, it was clear that the event was neither temporally nor spatially limited as described by assumptions based on literature and  described in section (Introduction). To confirm this suspicion, however, it was necessary to obtain further supporting data, which led to the need to use an additional range of instruments and to mitigate the large deadtime introduced by oscilloscope recording.

\medskip
\label[loop_antenna]
\picw=15cm \cinspic ./img/VLF_antenna.jpg
\caption/f The one of initial variants of STP loop VLF antenna mounted on the measuring car CAR1 has a resonant frequency of ~100 kHz. Its signal was directly sampled by an oscilloscope placed inside the car.
\medskip

\secc Manual trigger method

Although the trigger solution implemented with an oscilloscope proved relatively effective, it has certain drawbacks. One of the main limitations is the necessity to set the pulse level and pulse length parameters for each storm, and sometimes even for each phase of the storm. This characteristic resulted in the omission of some clearly visible lightning events, which the operator in the car was able to see, but the oscilloscope did not trigger. Although this disadvantage can be theoretically eliminated by using the "force trigger" button on the oscilloscope, such a solution was uncomfortable and also assumed that the oscilloscope was already booted up and set to the appropriate mode at the time.
It thus appeared that a probably more suitable solution would be to add a button for manual trigger operation for all devices, regardless of oscilloscope state.  That was achieved by adding a button to the car's gear lever as is depicted in the photo \ref[Manual_button]. This manual approach not only allows triggering of instruments before the oscilloscope is set, but it is also a comfortable solution for the driver to trigger while driving in a storm, where the driver often sees lightning in the storm, but resetting the oscilloscope while driving is not possible, as it would also have to dynamically change with the approaching storm.

Experimentally was also tested on a solution where multiple people sat in the vehicle, each visually monitoring their sector for the occurrence of lightning with a button in hand. That experiment has the result that the increase of sensitivity of multiple people is not proportional to increased manpower required. 
However, this visual based manual approach has multiple effects on recorded data. One of them is significantly decreased sensitivity of the human-generated trigger during daytime storms. There are even daytime storms where a person is unable to detect the occurrence of lightning discharges, but the trigger from the oscilloscope is recorded. Another effect, or perhaps more accurately a characteristic, is that such an implemented trigger is selective and lightning detected by this method contains a higher proportion of return strokes.

\medskip
\label[Manual_button]
\picw=10cm \cinspic ./img/manual_trigger_button.png
\caption/f Manual triggering button mounted on manual gear lever suitable to be operated by the car driver during the thunderstorm.
\medskip

The exploration of the manual and oscilloscope-based triggering methods has concluded that the most suitable solution is a combination of an algorithmic approach based on comparing the pulse height to a threshold and measuring its minimum duration before a trigger is executed. Additionally, a manual trigger is required to cover edge cases where the algorithmic trigger is not yet well-calibrated, but there is clear evidence of lightning. The specific implementation of the algorithmic trigger is discussed in subsequent chapters \ref[radio_receivers]. It also takes into account the fact that the time delay incurred by using a manual trigger is less significant than the overall duration of the lightning. Therefore the resulting delay is not predetermined by a specific phase of the lightning, where the trigger will respond to.

